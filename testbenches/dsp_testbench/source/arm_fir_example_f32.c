/* ----------------------------------------------------------------------
 * Copyright (C) 2010-2012 ARM Limited. All rights reserved.
 *
* $Date:         17. January 2013
* $Revision:     V1.4.0
*
* Project:       CMSIS DSP Library
 * Title:        arm_fir_example_f32.c
 *
 * Description:  Example code demonstrating how an FIR filter can be used
 *               as a low pass filter.
 *
 * Target Processor: Cortex-M4/Cortex-M3
 *
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions
* are met:
*   - Redistributions of source code must retain the above copyright
*     notice, this list of conditions and the following disclaimer.
*   - Redistributions in binary form must reproduce the above copyright
*     notice, this list of conditions and the following disclaimer in
*     the documentation and/or other materials provided with the
*     distribution.
*   - Neither the name of ARM LIMITED nor the names of its contributors
*     may be used to endorse or promote products derived from this
*     software without specific prior written permission.
*
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
* "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
* LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
* FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
* COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
* BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
* LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
* CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
* LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
* ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
* POSSIBILITY OF SUCH DAMAGE.
 * -------------------------------------------------------------------- */

/**
 * @ingroup groupExamples
 */

/**
 * @defgroup FIRLPF FIR Lowpass Filter Example
 *
 * \par Description:
 * \par
 * Removes high frequency signal components from the input using an FIR lowpass filter.
 * The example demonstrates how to configure an FIR filter and then pass data through
 * it in a block-by-block fashion.
 * \image html FIRLPF_signalflow.gif
 *
 * \par Algorithm:
 * \par
 * The input signal is a sum of two sine waves:  1 kHz and 15 kHz.
 * This is processed by an FIR lowpass filter with cutoff frequency 6 kHz.
 * The lowpass filter eliminates the 15 kHz signal leaving only the 1 kHz sine wave at the output.
 * \par
 * The lowpass filter was designed using MATLAB with a sample rate of 48 kHz and
 * a length of 29 points.
 * The MATLAB code to generate the filter coefficients is shown below:
 * <pre>
 *     h = fir1(28, 6/24);
 * </pre>
 * The first argument is the "order" of the filter and is always one less than the desired length.
 * The second argument is the normalized cutoff frequency.  This is in the range 0 (DC) to 1.0 (Nyquist).
 * A 6 kHz cutoff with a Nyquist frequency of 24 kHz lies at a normalized frequency of 6/24 = 0.25.
 * The CMSIS FIR filter function requires the coefficients to be in time reversed order.
 * <pre>
 *     fliplr(h)
 * </pre>
 * The resulting filter coefficients and are shown below.
 * Note that the filter is symmetric (a property of linear phase FIR filters)
 * and the point of symmetry is sample 14.  Thus the filter will have a delay of
 * 14 samples for all frequencies.
 * \par
 * \image html FIRLPF_coeffs.gif
 * \par
 * The frequency response of the filter is shown next.
 * The passband gain of the filter is 1.0 and it reaches 0.5 at the cutoff frequency 6 kHz.
 * \par
 * \image html FIRLPF_response.gif
 * \par
 * The input signal is shown below.
 * The left hand side shows the signal in the time domain while the right hand side is a frequency domain representation.
 * The two sine wave components can be clearly seen.
 * \par
 * \image html FIRLPF_input.gif
 * \par
 * The output of the filter is shown below.  The 15 kHz component has been eliminated.
 * \par
 * \image html FIRLPF_output.gif
 *
 * \par Variables Description:
 * \par
 * \li \c testInput_f32_1kHz_15kHz points to the input data
 * \li \c refOutput points to the reference output data
 * \li \c testOutput points to the test output data
 * \li \c firStateF32 points to state buffer
 * \li \c firCoeffs32 points to coefficient buffer
 * \li \c blockSize number of samples processed at a time
 * \li \c numBlocks number of frames
 *
 * \par CMSIS DSP Software Library Functions Used:
 * \par
 * - arm_fir_init_f32()
 * - arm_fir_f32()
 *
 * <b> Refer  </b>
 * \link arm_fir_example_f32.c \endlink
 *
 */


/** \example arm_fir_example_f32.c
 */

/* ----------------------------------------------------------------------
** Include Files
** ------------------------------------------------------------------- */

#include "arm_math.h"
#include "math_helper.h"

#include "fsl_device_registers.h"
#include "fsl_debug_console.h"
#include "board.h"

#include "pin_mux.h"
#include "clock_config.h"

/* ----------------------------------------------------------------------
** Macro Defines
** ------------------------------------------------------------------- */

#define TEST_LENGTH_SAMPLES  	320
#define SNR_THRESHOLD_F32    	130.0f
#define BLOCK_SIZE            	32
#define NUM_TAPS              	65
#define NUM_OF_FILTERS			8

/* -------------------------------------------------------------------
 * The input signal and reference output (computed with MATLAB)
 * are defined externally in arm_fir_lpf_data.c.
 * ------------------------------------------------------------------- */

extern float32_t testInput_f32_1kHz_15kHz[TEST_LENGTH_SAMPLES];
extern float32_t refOutput[TEST_LENGTH_SAMPLES];

/* -------------------------------------------------------------------
 * Declare Test output buffer
 * ------------------------------------------------------------------- */

static float32_t testOutput[TEST_LENGTH_SAMPLES];

/* -------------------------------------------------------------------
 * Declare State buffer of size (numTaps + blockSize - 1)
 * ------------------------------------------------------------------- */

static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS - 1];

/* ----------------------------------------------------------------------
** FIR Coefficients buffer generated using fir1() MATLAB function.
** fir1(28, 6/24)
** ------------------------------------------------------------------- */

const float32_t firCoeffs32[NUM_OF_FILTERS][NUM_TAPS] =
{
{-0.00211319018958735f, 0.000522504513715403f, 0.00333067976351975f, 0.00606280079957187f, 0.00845640372554800f, 0.0102574800082125f, 0.0112437919673325f, 0.0112471890369089f, 0.0101729722850570f, 0.00801449706814228f, 0.00486150557289915f, 0.000901123320867192f, -0.00358899524266904f, -0.00825526923923513f, -0.0126898038361763f, -0.0164576740337862f, -0.0191280260950576f, -0.0203067588895859f, -0.0196683300037837f, -0.0169842035686679f, -0.0121456261736106f, -0.00517877569725478f, 0.00374914860513427f, 0.0143336759156845f, 0.0261467064385734f, 0.0386593500421349f, 0.0512725525963824f, 0.0633534850525292f, 0.0742751990709248f, 0.0834567663662373f, 0.0904010417753521f, 0.0947273306829633f, 0.0961965908106956f, 0.0947273306829633f, 0.0904010417753521f, 0.0834567663662373f, 0.0742751990709248f, 0.0633534850525292f, 0.0512725525963824f, 0.0386593500421349f, 0.0261467064385734f, 0.0143336759156845f, 0.00374914860513427f, -0.00517877569725478f, -0.0121456261736106f, -0.0169842035686679f, -0.0196683300037837f, -0.0203067588895859f, -0.0191280260950576f, -0.0164576740337862f, -0.0126898038361763f, -0.00825526923923513f, -0.00358899524266904f, 0.000901123320867192f, 0.00486150557289915f, 0.00801449706814228f, 0.0101729722850570f, 0.0112471890369089f, 0.0112437919673325f, 0.0102574800082125f, 0.00845640372554800f, 0.00606280079957187f, 0.00333067976351975f, 0.000522504513715403f, -0.00211319018958735f},
{0.00986987182678594f, 0.00375869978760271f, -0.00457129264113444f, -0.0128727709618177f, -0.0186900441328536f, -0.0202202610795858f, -0.0169970908725220f, -0.0101255056328730f, -0.00194573242678950f, 0.00478843277933532f, 0.00794079641258116f, 0.00685558665059282f, 0.00270668808271615f, -0.00184680864818596f, -0.00363228133247420f, -0.000252994090977502f, 0.00876374817237083f, 0.0214123445499834f, 0.0335285914053441f, 0.0399735318503908f, 0.0363591033815006f, 0.0207672169018033f, -0.00513934147795827f, -0.0360648691876308f, -0.0642207061062206f, -0.0814034196311875f, -0.0814276758986877f, -0.0621715263756153f, -0.0265660997603516f, 0.0178441045244556f, 0.0607164225749483f, 0.0916190452185599f, 0.102861717242765f, 0.0916190452185599f, 0.0607164225749483f, 0.0178441045244556f, -0.0265660997603516f, -0.0621715263756153f, -0.0814276758986877f, -0.0814034196311875f, -0.0642207061062206f, -0.0360648691876308f, -0.00513934147795827f, 0.0207672169018033f, 0.0363591033815006f, 0.0399735318503908f, 0.0335285914053441f, 0.0214123445499834f, 0.00876374817237083f, -0.000252994090977502f, -0.00363228133247420f, -0.00184680864818596f, 0.00270668808271615f, 0.00685558665059282f, 0.00794079641258116f, 0.00478843277933532f, -0.00194573242678950f, -0.0101255056328730f, -0.0169970908725220f, -0.0202202610795858f, -0.0186900441328536f, -0.0128727709618177f, -0.00457129264113444f, 0.00375869978760271f, 0.00986987182678594f},
{-0.0158635630778934f, -0.0118982542820018f, 0.000747058072935385f, 0.0145281424123965f, 0.0202293658783336f, 0.0137331877310236f, -0.000680011716756494f, -0.0133325910419249f, -0.0163521167416621f, -0.00946393040541374f, 0.000321638456932633f, 0.00495590552060028f, 0.00236690985703129f, -0.00183688777065241f, 0.000190248059471058f, 0.0103007529710772f, 0.0206896669070295f, 0.0190263299122238f, -0.000644384189019466f, -0.0299296693562918f, -0.0487874077710074f, -0.0389484059636668f, 0.000846432372064383f, 0.0497647425292439f, 0.0758305280502250f, 0.0571887986366839f, -0.000704719097061710f, -0.0651322465962297f, -0.0953582722452290f, -0.0693199899485542f, 0.000272569742576701f, 0.0722371935074672f, 0.102474740057641f, 0.0722371935074672f, 0.000272569742576701f, -0.0693199899485542f, -0.0953582722452290f, -0.0651322465962297f, -0.000704719097061710f, 0.0571887986366839f, 0.0758305280502250f, 0.0497647425292439f, 0.000846432372064383f, -0.0389484059636668f, -0.0487874077710074f, -0.0299296693562918f, -0.000644384189019466f, 0.0190263299122238f, 0.0206896669070295f, 0.0103007529710772f, 0.000190248059471058f, -0.00183688777065241f, 0.00236690985703129f, 0.00495590552060028f, 0.000321638456932633f, -0.00946393040541374f, -0.0163521167416621f, -0.0133325910419249f, -0.000680011716756494f, 0.0137331877310236f, 0.0202293658783336f, 0.0145281424123965f, 0.000747058072935385f, -0.0118982542820018f, -0.0158635630778934f},
{0.0114411090717854f, 0.0165380572273883f, 0.00240846835883626f, -0.0163965874381038f, -0.0176891007986231f, 0.000837768723362836f, 0.0177940468307927f, 0.0142399801628911f, -0.00343634923966923f, -0.0134193780447341f, -0.00707496348576476f, 0.00254778774000949f, 0.00241634369292907f, -0.00135722682789177f, 0.00428039149952701f, 0.0141478042250982f, 0.00770357574636662f, -0.0181047047439228f, -0.0333191954593418f, -0.00877830572701143f, 0.0379324138679590f, 0.0509493824663633f, 0.00269410454669772f, -0.0607013224679361f, -0.0628582244186276f, 0.0103487762707755f, 0.0819600119445723f, 0.0660992394206584f, -0.0279199921263261f, -0.0970672310492389f, -0.0599008502071564f, 0.0459521242739052f, 0.102534171437945f, 0.0459521242739052f, -0.0599008502071564f, -0.0970672310492389f, -0.0279199921263261f, 0.0660992394206584f, 0.0819600119445723f, 0.0103487762707755f, -0.0628582244186276f, -0.0607013224679361f, 0.00269410454669772f, 0.0509493824663633f, 0.0379324138679590f, -0.00877830572701143f, -0.0333191954593418f, -0.0181047047439228f, 0.00770357574636662f, 0.0141478042250982f, 0.00428039149952701f, -0.00135722682789177f, 0.00241634369292907f, 0.00254778774000949f, -0.00707496348576476f, -0.0134193780447341f, -0.00343634923966923f, 0.0142399801628911f, 0.0177940468307927f, 0.000837768723362836f, -0.0176891007986231f, -0.0163965874381038f, 0.00240846835883626f, 0.0165380572273883f, 0.0114411090717854f},
{0.000600284908252139f, -0.0171761223378898f, -0.00610824698095375f, 0.0175844949427824f, 0.0118162867169738f, -0.0145385642735737f, -0.0155332434667128f, 0.00897414281966385f, 0.0154351176465715f, -0.00302851202367092f, -0.0108111510109104f, -0.000521234744898018f, 0.00253068616932981f, -0.000869363570537383f, 0.00696663968860203f, 0.00858885844627725f, -0.0142127173512932f, -0.0221999864543959f, 0.0156665078092263f, 0.0392723373625850f, -0.00881670468157557f, -0.0558240235878783f, -0.00690619909726138f, 0.0672903410736166f, 0.0297114072797139f, -0.0697631946801383f, -0.0556906521812587f, 0.0611431912398211f, 0.0796936938747615f, -0.0418534377631013f, -0.0966112280018941f, 0.0148823228950620f, 0.102706508343789f, 0.0148823228950620f, -0.0966112280018941f, -0.0418534377631013f, 0.0796936938747615f, 0.0611431912398211f, -0.0556906521812587f, -0.0697631946801383f, 0.0297114072797139f, 0.0672903410736166f, -0.00690619909726138f, -0.0558240235878783f, -0.00881670468157557f, 0.0392723373625850f, 0.0156665078092263f, -0.0221999864543959f, -0.0142127173512932f, 0.00858885844627725f, 0.00696663968860203f, -0.000869363570537383f, 0.00253068616932981f, -0.000521234744898018f, -0.0108111510109104f, -0.00302851202367092f, 0.0154351176465715f, 0.00897414281966385f, -0.0155332434667128f, -0.0145385642735737f, 0.0118162867169738f, 0.0175844949427824f, -0.00610824698095375f, -0.0171761223378898f, 0.000600284908252139f},
{-0.0122556444952426f, 0.0133000034758507f, 0.00961149511062668f, -0.0185333917221406f, -0.00371279074745663f, 0.0201828763968970f, -0.00322257268369246f, -0.0172438567842698f, 0.00809399058146180f, 0.0107025594876581f, -0.00815313053525404f, -0.00347765741489526f, 0.00229271773982744f, -0.000472781780574755f, 0.00814302433345242f, -0.00237478297470612f, -0.0194248326980401f, 0.0135752947562985f, 0.0264704284618307f, -0.0317233330012143f, -0.0245558027799328f, 0.0524543005558058f, 0.0111252212554405f, -0.0695468138644079f, 0.0129711192457784f, 0.0768237931548151f, -0.0433205736515932f, -0.0702271156741067f, 0.0730147241468597f, 0.0493359396581268f, -0.0946409692621715f, -0.0177623095686121f, 0.102551683253453f, -0.0177623095686121f, -0.0946409692621715f, 0.0493359396581268f, 0.0730147241468597f, -0.0702271156741067f, -0.0433205736515932f, 0.0768237931548151f, 0.0129711192457784f, -0.0695468138644079f, 0.0111252212554405f, 0.0524543005558058f, -0.0245558027799328f, -0.0317233330012143f, 0.0264704284618307f, 0.0135752947562985f, -0.0194248326980401f, -0.00237478297470612f, 0.00814302433345242f, -0.000472781780574755f, 0.00229271773982744f, -0.00347765741489526f, -0.00815313053525404f, 0.0107025594876581f, 0.00809399058146180f, -0.0172438567842698f, -0.00322257268369246f, 0.0201828763968970f, -0.00371279074745663f, -0.0185333917221406f, 0.00961149511062668f, 0.0133000034758507f, -0.0122556444952426f},
{0.0157463896124725f, -0.00634240842512460f, -0.0122560614697531f, 0.0193578960372632f, -0.00565253839505790f, -0.0143702385913480f, 0.0186543872970696f, -0.00356072035737050f, -0.0126175342636703f, 0.0128233708674441f, -0.00116331890804869f, -0.00561973462277193f, 0.00212159555170581f, 6.84594558794798e-05f, 0.00712109463586430f, -0.0120836454691688f, -0.00129433606361364f, 0.0249256177149891f, -0.0275531371676901f, -0.00618402274153367f, 0.0459034348044579f, -0.0416467548887877f, -0.0146775031845038f, 0.0672193219441317f, -0.0519131383141347f, -0.0258470029030788f, 0.0856165248565287f, -0.0566479242524900f, -0.0378800637052381f, 0.0980816112011641f, -0.0552753618971410f, -0.0484538688535784f, 0.102491494123789f, -0.0484538688535784f, -0.0552753618971410f, 0.0980816112011641f, -0.0378800637052381f, -0.0566479242524900f, 0.0856165248565287f, -0.0258470029030788f, -0.0519131383141347f, 0.0672193219441317f, -0.0146775031845038f, -0.0416467548887877f, 0.0459034348044579f, -0.00618402274153367f, -0.0275531371676901f, 0.0249256177149891f, -0.00129433606361364f, -0.0120836454691688f, 0.00712109463586430f, 6.84594558794798e-05f, 0.00212159555170581f, -0.00561973462277193f, -0.00116331890804869f, 0.0128233708674441f, -0.0126175342636703f, -0.00356072035737050f, 0.0186543872970696f, -0.0143702385913480f, -0.00565253839505790f, 0.0193578960372632f, -0.0122560614697531f, -0.00634240842512460f, 0.0157463896124725f},
{-0.00897857569264453f, -0.00258128605429599f, 0.0147912016792045f, -0.0197069879248466f, 0.0134738699584335f, 0.000571373623104392f, -0.0138481227654219f, 0.0183900600078018f, -0.0123992398051172f, 0.00128892821962681f, 0.00669557606606430f, -0.00698237299933053f, 0.00216411838187098f, 0.000510444765701973f, 0.00410218383132986f, -0.0134816302425906f, 0.0181299819268222f, -0.00892060844604389f, -0.0140369907899253f, 0.0382925303766589f, -0.0455395396128622f, 0.0244897295719198f, 0.0186535687557421f, -0.0605692398527129f, 0.0737073642262985f, -0.0444262295238690f, -0.0156556809364605f, 0.0738235235964047f, -0.0948796430413683f, 0.0631863273453218f, 0.00607986859424931f, -0.0744748847123034f, 0.102745006715041f, -0.0744748847123034f, 0.00607986859424931f, 0.0631863273453218f, -0.0948796430413683f, 0.0738235235964047f, -0.0156556809364605f, -0.0444262295238690f, 0.0737073642262985f, -0.0605692398527129f, 0.0186535687557421f, 0.0244897295719198f, -0.0455395396128622f, 0.0382925303766589f, -0.0140369907899253f, -0.00892060844604389f, 0.0181299819268222f, -0.0134816302425906f, 0.00410218383132986f, 0.000510444765701973f, 0.00216411838187098f, -0.00698237299933053f, 0.00669557606606430f, 0.00128892821962681f, -0.0123992398051172f, 0.0183900600078018f, -0.0138481227654219f, 0.000571373623104392f, 0.0134738699584335f, -0.0197069879248466f, 0.0147912016792045f, -0.00258128605429599f, -0.00897857569264453f}
};

const float32_t eqGains32[NUM_OF_FILTERS] = {3.0f, 0.1f, 6.0f, 0.5f, 2.0f, 0.0f, 0.9f, 5.0f};

/* ------------------------------------------------------------------
 * Global variables for FIR LPF Example
 * ------------------------------------------------------------------- */

uint32_t blockSize = BLOCK_SIZE;
uint32_t numBlocks = TEST_LENGTH_SAMPLES/BLOCK_SIZE;

float32_t  snr;

/* ----------------------------------------------------------------------
 * FIR LPF Example
 * ------------------------------------------------------------------- */

int32_t main(void)
{

	/* Init board hardware. */
	BOARD_InitPins();
	BOARD_InitBootClocks();
	BOARD_InitDebugConsole();

  uint32_t i;
  arm_fir_instance_f32 S[NUM_OF_FILTERS];
  arm_status status;
  float32_t  *inputF32, *outputF32;
  float32_t	 outputAux[NUM_TAPS];

  /* Initialize input and output buffer pointers */
  inputF32 = &testInput_f32_1kHz_15kHz[0];
  outputF32 = &testOutput[0];

  /* Call FIR init function to initialize the instance structure. */
  for(uint32_t j=0; j < NUM_OF_FILTERS; j++)
  {
	  arm_fir_init_f32(&(S[j]), NUM_TAPS, (float32_t *)&firCoeffs32[0], &firStateF32[0], blockSize);
  }

  /* ----------------------------------------------------------------------
  ** Call the FIR process function for every blockSize samples
  ** ------------------------------------------------------------------- */

  for(i=0; i < numBlocks; i++)
  {
    for(uint32_t j=0; j < NUM_OF_FILTERS; j++)
    {
    	arm_fir_f32(&(S[j]), inputF32 + (i * blockSize), outputAux, blockSize);
    	for(uint32_t k=0; k < blockSize; k++)
    	{
    		outputF32[k + (i * blockSize)] += eqGains32[k] * outputAux[k];
    	}
    }
  }

  /* ----------------------------------------------------------------------
  ** Compare the generated output against the reference output computed
  ** in MATLAB.
  ** ------------------------------------------------------------------- */

  snr = arm_snr_f32(&refOutput[0], &testOutput[0], TEST_LENGTH_SAMPLES);

  if (snr < SNR_THRESHOLD_F32)
  {
    status = ARM_MATH_TEST_FAILURE;
  }
  else
  {
    status = ARM_MATH_SUCCESS;
  }

  /* ----------------------------------------------------------------------
  ** Loop here if the signal does not match the reference output.
  ** ------------------------------------------------------------------- */

  if ( status != ARM_MATH_SUCCESS)
  {
    while (1);
  }

  while (1);                             /* main function does not return */
}

/** \endlink */
